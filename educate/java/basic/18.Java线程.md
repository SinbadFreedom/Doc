18. Javaçº¿ç¨‹
===

<div class="jumbotron">
<p>éƒ¨åˆ†å†…å®¹æºè‡ª:ã€Šæ·±å…¥ç†è§£JVMè™šæ‹Ÿæœºã€‹.
</p>
</div>


â‘  çº¿ç¨‹å’Œè¿›ç¨‹çš„æ¦‚å¿µ
---

è¿›ç¨‹æ˜¯æŒ‡ä¸€ä¸ªå†…å­˜ä¸­è¿è¡Œæœ‰è‡ªå·±ç‹¬ç«‹çš„ä¸€å—å†…å­˜ç©ºé—´çš„åº”ç”¨ç¨‹åº.ä¸€ä¸ªè¿›ç¨‹ä¸­è‡³å°‘ä¸€ä¸ªçº¿ç¨‹.

çº¿ç¨‹æ˜¯æŒ‡è¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ‰§è¡Œæµç¨‹.æ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„è¿è¡Œæ ˆ. çº¿ç¨‹ä»å±äºè¿›ç¨‹. ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥è¿è¡Œå¤šä¸ªçº¿ç¨‹.è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„å†…å­˜.

çº¿ç¨‹å’Œè¿›ç¨‹ä¸€æ ·åˆ†ä¸ºäº”ä¸ªé˜¶æ®µ:åˆ›å»ºã€å°±ç»ªã€è¿è¡Œã€é˜»å¡ã€ç»ˆæ­¢.

å¤šè¿›ç¨‹æ˜¯æŒ‡æ“ä½œç³»ç»Ÿèƒ½åŒæ—¶è¿è¡Œå¤šä¸ªä»»åŠ¡(ç¨‹åº).

å¤šçº¿ç¨‹æ˜¯æŒ‡åœ¨åŒä¸€ç¨‹åºä¸­,æœ‰å¤šä¸ªé¡ºåºæµåœ¨æ‰§è¡Œ.

![çº¿ç¨‹](http://localhost/img/java/basic/18-1.jpg)   

â‘¡ çº¿ç¨‹çš„å®ç°
---
çº¿ç¨‹æ˜¯æ¯”è¿›ç¨‹æ›´è½»é‡çº§çš„è°ƒåº¦æ‰§è¡Œå•ä½,çº¿ç¨‹çš„å¼•å…¥,å¯ä»¥æŠŠä¸€ä¸ªè¿›ç¨‹çš„èµ„æºåˆ†é…å’Œæ‰§è¡Œè°ƒåº¦åˆ†å¼€,å„ä¸ªçº¿ç¨‹æ—¢å¯ä»¥å…±äº«è¿›ç¨‹èµ„æº(å†…å­˜åœ°å€ã€æ–‡ä»¶I/Oç­‰),åˆå¯ä»¥ç‹¬ç«‹è°ƒåº¦(çº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„åŸºæœ¬å•ä½).

ä¸»æµçš„æ“ä½œç³»ç»Ÿéƒ½æä¾›äº†çº¿ç¨‹å®ç°,Javaè¯­è¨€åˆ™æä¾›äº†åœ¨ä¸åŒç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿå¹³å°ä¸‹å¯¹çº¿ç¨‹æ“ä½œçš„ç»Ÿä¸€å¤„ç†.

Threadç±»ä¸­æ‰€æœ‰å…³é”®æ–¹æ³•éƒ½æ˜¯å£°æ˜ä¸ºNativeçš„,åœ¨Java APIä¸­,æœ¬åœ°æ–¹æ³•å¾€å¾€æ„å‘³ç€è¿™ä¸ªæ–¹æ³•æ²¡æœ‰ä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨å¹³å°æ— å…³çš„æ‰‹æ®µæ¥å®ç°(å½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸ºäº†æ‰§è¡Œæ•ˆç‡è€Œä½¿ç”¨Nativeæ–¹æ³•)

â‘¢ Javaçº¿ç¨‹è°ƒåº¦
---

Javaçš„çº¿ç¨‹è°ƒåº¦æ–¹å¼æ˜¯æŠ¢å å¼è°ƒåº¦,è™½ç„¶Javaçº¿ç¨‹çš„è°ƒåº¦æ˜¯ç³»ç»Ÿè‡ªåŠ¨å®Œæˆçš„,ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥â€œå»ºè®®â€ç³»ç»Ÿç»™æŸäº›çº¿ç¨‹å¤šåˆ†é…ä¸€ç‚¹æ‰§è¡Œæ—¶é—´,å¦å¤–çš„ä¸€äº›çº¿ç¨‹åˆ™å¯ä»¥å°‘åˆ†é…ä¸€ç‚¹â€”â€”è¿™é¡¹æ“ä½œå¯ä»¥é€šè¿‡è®¾ç½®ä¼˜å…ˆçº§æ¥å®Œæˆ.

ä¸è¿‡,çº¿ç¨‹çš„ä¼˜å…ˆçº§å¹¶ä¸æ˜¯å¤ªé è°±,å› ä¸ºJavaçº¿ç¨‹æ˜¯é€šè¿‡æ˜ å°„åˆ°åŸç”Ÿçº¿ç¨‹ä¸Šæ¥å®ç°çš„,æ‰€ä»¥çº¿ç¨‹è°ƒåº¦æœ€ç»ˆè¿˜æ˜¯å–å†³äºæ“ä½œç³»ç»Ÿ,è™½ç„¶ç°åœ¨å¾ˆå¤šæ“ä½œç³»ç»Ÿéƒ½æä¾›äº†ä¼˜å…ˆçº§çš„æ¦‚å¿µ,ä½†æ˜¯å¹¶ä¸è§å¾—ä¸Javaçº¿ç¨‹çš„ä¼˜å…ˆçº§ä¸€ä¸€å¯¹åº”.æ¯”å¦‚:Windowsä¸­å°±åªæœ‰7ç§çº¿ç¨‹ä¼˜å…ˆçº§,è€ŒJavaè¯­è¨€ä¸€å…±è®¾ç½®äº†10ä¸ªçº§åˆ«çš„çº¿ç¨‹ä¼˜å…ˆçº§.

â‘£ Javaä¸­çº¿ç¨‹çš„å®ç°
---

åœ¨Javaä¸­æƒ³å®ç°å¤šçº¿ç¨‹æœ‰ä¸¤ç§æ‰‹æ®µ,ä¸€ç§æ˜¯é›†æˆThreadç±»,å¦ä¸€ç§å°±æ˜¯å®ç°Runnableæ¥å£.

###1.ç»§æ‰¿è‡ªThreadç±»

```java
package com.dashidan.lesson18;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * ç»§æ‰¿è‡ªThreadç±»
 */
public class MyThread1 extends Thread {

    @Override
    public void run() {
        System.out.println("MyThread1 run.");
    }
}

```

###2.å®ç°Runnableæ¥å£
é¦–å…ˆå®šä¹‰ä¸€ä¸ªçº¿ç¨‹ç±»ç»§æ‰¿è‡ªRunnableæ¥å£,å¦‚: 
```java
package com.dashidan.lesson18;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * å®ç°Runnableæ¥å£
 */
public class MyThread2 implements Runnable {
    @Override
    public void run() {
        System.out.println("MyThread2 run.");
    }
}
```

å…¥å£ç±»,å®ä¾‹åŒ–çº¿ç¨‹ç±»çš„å¯¹è±¡,å‘åŠ¨å¯åŠ¨çº¿ç¨‹çš„å‘½ä»¤
```java
package com.dashidan.lesson18;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 */
public class Demo1 {
    public static void main(String[] args) {
        MyThread1 t1 = new MyThread1();
        /** t1 çº¿ç¨‹å¯åŠ¨*/
        t1.start();
        MyThread2 myThread2 = new MyThread2();
        Thread t2 = new Thread(myThread2);
        /** t2 çº¿ç¨‹å¯åŠ¨*/
        t2.start();
    }
}

```

è¾“å‡º:

	MyThread2 run.
	MyThread1 run.
	
<div class="bs-callout bs-callout-warning">
    <h4>è¾“å‡ºçš„é¡ºåºå¯èƒ½ä¸ä¸€è‡´</h4>
	<p>å¤šè¿è¡Œå‡ æ¬¡, è¾“å‡ºçš„é¡ºåºå¯èƒ½ä¸ä¸€è‡´, è¿™ä¸ªæ˜¯ç”±äºçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºæ— æ³•ä¿è¯å¯¼è‡´.</p>
</div>

<div class="bs-callout bs-callout-success">
    <h4>ç»§æ‰¿Threadå’Œå®ç°Runnableæ¥å£å¦‚ä½•é€‰æ‹©</h4>
	<p>ç”±äºJavaæ˜¯å•æ ¹ç»§æ‰¿ä½“ç³», å½“ä¸€ä¸ªç±»éœ€è¦ç»§æ‰¿ä¸å…¶ä»–ç±», è¿˜éœ€è¦å…·æœ‰çº¿ç¨‹çš„èƒ½åŠ›, è¿™æ—¶åªèƒ½é‡‡ç”¨å®ç°Runableæ¥å£çš„æ–¹å¼.</p>
</div>

â‘¤ å¯åŠ¨çº¿ç¨‹
---

åœ¨çº¿ç¨‹çš„Threadå¯¹è±¡ä¸Šè°ƒç”¨start()æ–¹æ³•,è€Œä¸æ˜¯run()æˆ–è€…åˆ«çš„æ–¹æ³•.åœ¨è°ƒç”¨start()æ–¹æ³•ä¹‹å‰,çº¿ç¨‹å¤„äºæ–°çŠ¶æ€ä¸­, æ–°çŠ¶æ€æŒ‡æœ‰ä¸€ä¸ªThreadå¯¹è±¡, ä½†è¿˜æ²¡æœ‰ä¸€ä¸ªçœŸæ­£çš„çº¿ç¨‹. åœ¨è°ƒç”¨start()æ–¹æ³•ä¹‹å,å‘ç”Ÿäº†ä¸€ç³»åˆ—å¤æ‚çš„äº‹æƒ…

1. å¯åŠ¨æ–°çš„æ‰§è¡Œçº¿ç¨‹(å…·æœ‰æ–°çš„è°ƒç”¨æ ˆ).
2. è¯¥çº¿ç¨‹ä»æ–°çŠ¶æ€è½¬ç§»åˆ°å¯è¿è¡ŒçŠ¶æ€.
3. å½“è¯¥çº¿ç¨‹è·å¾—æœºä¼šæ‰§è¡Œæ—¶,å…¶ç›®æ ‡run()æ–¹æ³•å°†è¿è¡Œ.

<div class="bs-callout bs-callout-danger">
    <h4>run()æ–¹æ³•</h4>	
	<p>å¯¹Javaæ¥è¯´,run()æ–¹æ³•æ˜¯çº¿ç¨‹å¯åŠ¨çš„å…¥å£æ–¹æ³•, åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªæ™®é€šçš„æ–¹æ³•. å› æ­¤,åœ¨Runnableä¸Šæˆ–è€…Threadä¸Šè°ƒç”¨runæ–¹æ³•æ˜¯åˆæ³•çš„.ä½†å¹¶ä¸å¯åŠ¨æ–°çš„çº¿ç¨‹.æ‰€ä»¥ä¸å»ºè®®ç›´æ¥è°ƒç”¨run()æ–¹æ³•.</p>
</div>

â‘¥ Javaçº¿ç¨‹çš„çŠ¶æ€
---
Javaçº¿ç¨‹å…·æœ‰äº”ä¸­åŸºæœ¬çŠ¶æ€

1. æ–°å»ºçŠ¶æ€(New)

åœ¨ç”Ÿæˆçº¿ç¨‹å¯¹è±¡,å¹¶æ²¡æœ‰è°ƒç”¨è¯¥å¯¹è±¡çš„startæ–¹æ³•.å¦‚:

```java
Thread t = new MyThread1();
```

2. å°±ç»ªçŠ¶æ€(Runnable)

å½“è°ƒç”¨äº†çº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•ä¹‹å,è¯¥çº¿ç¨‹å°±è¿›å…¥äº†å°±ç»ªçŠ¶æ€,ä½†æ˜¯æ­¤æ—¶çº¿ç¨‹è°ƒåº¦ç¨‹åºè¿˜æ²¡æœ‰æŠŠè¯¥çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹,æ­¤æ—¶å¤„äºå°±ç»ªçŠ¶æ€.éšæ—¶ç­‰å¾…CPUè°ƒåº¦æ‰§è¡Œ,å¹¶ä¸æ˜¯è¯´æ‰§è¡Œäº†t.start()æ­¤çº¿ç¨‹ç«‹å³å°±ä¼šæ‰§è¡Œ. åœ¨çº¿ç¨‹è¿è¡Œä¹‹å,ä»ç­‰å¾…æˆ–è€…ç¡çœ ä¸­å›æ¥ä¹‹å,ä¹Ÿä¼šå¤„äºå°±ç»ªçŠ¶æ€.

3. è¿è¡ŒçŠ¶æ€(Running)

çº¿ç¨‹è°ƒåº¦ç¨‹åºå°†å¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹,æ­¤æ—¶çº¿ç¨‹å°±è¿›å…¥äº†è¿è¡ŒçŠ¶æ€,å¼€å§‹è¿è¡Œrunå‡½æ•°å½“ä¸­çš„ä»£ç .å°±ç»ªçŠ¶æ€æ˜¯è¿›å…¥åˆ°è¿è¡ŒçŠ¶æ€çš„å”¯ä¸€å…¥å£,ä¹Ÿå°±æ˜¯è¯´,çº¿ç¨‹è¦æƒ³è¿›å…¥è¿è¡ŒçŠ¶æ€æ‰§è¡Œ,é¦–å…ˆå¿…é¡»å¤„äºå°±ç»ªçŠ¶æ€ä¸­.

4. é˜»å¡çŠ¶æ€(Blocked)

çº¿ç¨‹æ­£åœ¨è¿è¡Œçš„æ—¶å€™,æš‚æ—¶æ”¾å¼ƒå¯¹CPUçš„ä½¿ç”¨æƒ,åœæ­¢æ‰§è¡Œ,æ­¤æ—¶è¿›å…¥é˜»å¡çŠ¶æ€.é€šå¸¸æ˜¯ä¸ºäº†ç­‰å¾…æŸä¸ªæ—¶é—´çš„å‘ç”Ÿ(æ¯”å¦‚è¯´æŸé¡¹èµ„æºå°±ç»ª)ä¹‹åå†ç»§ç»­è¿è¡Œ.sleep,suspend,waitç­‰æ–¹æ³•éƒ½å¯ä»¥å¯¼è‡´çº¿ç¨‹é˜»å¡.

å¤„äºè¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹ç›´åˆ°å…¶è¿›å…¥åˆ°å°±ç»ªçŠ¶æ€,æ‰æœ‰æœºä¼šå†æ¬¡è¢«CPUè°ƒç”¨ä»¥è¿›å…¥åˆ°è¿è¡ŒçŠ¶æ€.æ ¹æ®é˜»å¡äº§ç”Ÿçš„åŸå› ä¸åŒ,é˜»å¡çŠ¶æ€åˆå¯ä»¥åˆ†ä¸ºä¸‰ç§:

* ç­‰å¾…é˜»å¡

è¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹æ‰§è¡Œwait()æ–¹æ³•,ä½¿æœ¬çº¿ç¨‹è¿›å…¥åˆ°ç­‰å¾…é˜»å¡çŠ¶æ€.
wait()ã€notify()ã€notifyAll()æ˜¯ä¸‰ä¸ªå®šä¹‰åœ¨Objectç±»é‡Œçš„æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶çº¿ç¨‹çš„çŠ¶æ€.
ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ï¼Œå¯¹è±¡çš„æ§åˆ¶æƒï¼ˆmonitorï¼‰åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰.
æ— è®ºæ˜¯æ‰§è¡Œå¯¹è±¡çš„waitã€notifyè¿˜æ˜¯notifyAllæ–¹æ³•ï¼Œå¿…é¡»ä¿è¯å½“å‰è¿è¡Œçš„çº¿ç¨‹å–å¾—äº†è¯¥å¯¹è±¡çš„æ§åˆ¶æƒï¼ˆmonitorï¼‰
å¦‚æœåœ¨æ²¡æœ‰æ§åˆ¶æƒçš„çº¿ç¨‹é‡Œæ‰§è¡Œå¯¹è±¡çš„ä»¥ä¸Šä¸‰ç§æ–¹æ³•ï¼Œå°±ä¼šæŠ¥java.lang.IllegalMonitorStateExceptionå¼‚å¸¸.

æ‰§è¡Œæ—¶wait(), sleep()æ—¶ä¼šæŠ›å‡ºInterruptedException, éœ€è¦æ”¾åœ¨try-catchè¯­å¥ä¸­æ‰§è¡Œ.

æŠ¥é”™ç¤ºä¾‹:
```java
package com.dashidan.lesson18;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * çº¿ç¨‹é˜»å¡çŠ¶æ€-wait()
 */
public class WaitThread extends Thread {
    @Override
    public void run() {
        System.out.println("WaitThread run.");
        try {
            System.out.println("WaitThread before wait.");
            this.wait();
            System.out.println("WaitThread after wait.");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

```

å…¥å£ç±»:
```java
package com.dashidan.lesson18;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * çº¿ç¨‹é˜»å¡çŠ¶æ€ wait()
 */
public class Demo2 {
    public static void main(String[] args) {
        WaitThread waitThread = new WaitThread();
        waitThread.start();
    }
}

```

è¾“å‡º:

	WaitThread run.
	WaitThread before wait.
	Exception in thread "Thread-0" java.lang.IllegalMonitorStateException
		at java.lang.Object.wait(Native Method)
		at java.lang.Object.wait(Object.java:502)
		at com.dashidan.lesson18.WaitThread.run(WaitThread.java:15)

		
		
çº¿ç¨‹å–å¾—æ§åˆ¶æƒçš„æ–¹æ³•æœ‰ä¸‰ç§:
* æ‰§è¡Œå¯¹è±¡çš„æŸä¸ªåŒæ­¥å®ä¾‹æ–¹æ³•.
* æ‰§è¡Œå¯¹è±¡å¯¹åº”ç±»çš„åŒæ­¥é™æ€æ–¹æ³•.
* æ‰§è¡Œå¯¹è¯¥å¯¹è±¡åŠ åŒæ­¥é”çš„åŒæ­¥å—.

å¦‚æœå¯¹è±¡è°ƒç”¨äº†waitæ–¹æ³•å°±ä¼šä½¿æŒæœ‰è¯¥å¯¹è±¡çš„çº¿ç¨‹æŠŠè¯¥å¯¹è±¡çš„æ§åˆ¶æƒäº¤å‡ºå»ï¼Œç„¶åå¤„äºç­‰å¾…çŠ¶æ€.
å¦‚æœå¯¹è±¡è°ƒç”¨äº†notifyæ–¹æ³•å°±ä¼šé€šçŸ¥æŸä¸ªæ­£åœ¨ç­‰å¾…è¿™ä¸ªå¯¹è±¡çš„æ§åˆ¶æƒçš„çº¿ç¨‹å¯ä»¥ç»§ç»­è¿è¡Œ, ç”±Javaè™šæ‹Ÿæœºæ¥å†³å®šå“ªä¸ªçº¿ç¨‹ç»§ç»­è¿è¡Œ.
å¦‚æœå¯¹è±¡è°ƒç”¨äº†notifyAllæ–¹æ³•å°±ä¼šé€šçŸ¥æ‰€æœ‰ç­‰å¾…è¿™ä¸ªå¯¹è±¡æ§åˆ¶æƒçš„çº¿ç¨‹ç»§ç»­è¿è¡Œ
å¯ä»¥é€šè¿‡synchronizeå…³é”®å­—æ¥è·å–åŒæ­¥é”, ç„¶åå†è°ƒç”¨wait(), notify(), notifyAll().


```java
package com.dashidan.lesson18;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * çº¿ç¨‹é˜»å¡çŠ¶æ€ wait() , è·å¾—åŒæ­¥é”
 */
public class Demo3 {

    public static Object object = new Object();

    public static void main(String[] args) {
        WaitThread waitThread = new WaitThread(object);
        waitThread.start();

        try {
            /** ä¸»çº¿ç¨‹ä¼‘çœ 3ç§’*/
            System.out.println("ä¸»çº¿ç¨‹ä¼‘çœ 3ç§’");
            Thread.sleep(3000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        /** 3ç§’åæ‰§è¡Œ notifyAll */
        synchronized (object) {
            object.notifyAll();
        }
    }
}

class WaitThread extends Thread {
    Object object;

    public WaitThread(Object object) {
        this.object = object;
    }

    @Override
    public void run() {
        System.out.println("WaitThread run.");
        synchronized (object) {
            try {
                System.out.println("WaitThread before lock " + this.getName());
                object.wait();
                System.out.println("WaitThread after lock " + this.getName());
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
```

è¾“å‡º:

	ä¸»çº¿ç¨‹ä¼‘çœ 3ç§’
	WaitThread run.
	WaitThread before lock Thread-0
	WaitThread after lock Thread-0

* åŒæ­¥é˜»å¡

çº¿ç¨‹åœ¨è·å–synchronizedåŒæ­¥é”å¤±è´¥(å› ä¸ºé”è¢«å…¶å®ƒçº¿ç¨‹æ‰€å ç”¨),å®ƒä¼šè¿›å…¥åŒæ­¥é˜»å¡çŠ¶æ€. å½“é”è¢«é‡Šæ”¾å, å…¶ä»–è·å¾—è¯¥é”çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œ.

```java
package com.dashidan.lesson18;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * çº¿ç¨‹é˜»å¡çŠ¶æ€ åŒæ­¥é˜»å¡
 */
public class Demo5 {
    public static Object lock = new Object();

    public static void main(String[] args) {
        SyncThread syncThread = new SyncThread("t1", lock);
        syncThread.start();

        SyncThread syncThread1 = new SyncThread("t2",lock);
        syncThread1.start();
    }
}

class SyncThread extends Thread {
    public Object lock;

    public SyncThread(String name, Object lock) {
        super(name);
        this.lock = lock;
    }

    @Override
    public void run() {
        try {
            synchronized (lock) {
                /** ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™ä¸ªè¯­å¥å—çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…. */
                System.out.println(this.getName() + " before sleep.");
                Thread.sleep(3000);
                System.out.println(this.getName() + " after sleep.");
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

```

è¾“å‡º:

	t2 before sleep.
	t2 after sleep.
	t1 before sleep.
	t1 after sleep.

<div class="bs-callout bs-callout-success">
<h4>å¤šè¿è¡Œå‡ æ¬¡, è¾“å‡ºç»“æœå¯èƒ½ä¸ä¸€è‡´, ä½†æ¯æ¬¡éƒ½æ˜¯æ‰§è¡Œå®Œä¸€ä¸ªçº¿ç¨‹, å†æ‰§è¡Œå¦ä¸€ä¸ª.</h4>	
</div>

<div class="bs-callout bs-callout-success">
<h4>sleep()æ–¹æ³•ä¼šé‡Šæ”¾cpu, è¿›å…¥ç­‰å¾…æ‰§è¡Œçš„çŠ¶æ€, ä½†ä¸ä¼šé‡Šæ”¾æ‰€æŒå¯¹è±¡çš„é”.</h4>	
</div>

* å…¶ä»–é˜»å¡

é€šè¿‡è°ƒç”¨çº¿ç¨‹çš„sleep()æˆ–join()æˆ–å‘å‡ºäº†I/Oè¯·æ±‚æ—¶,çº¿ç¨‹ä¼šè¿›å…¥åˆ°é˜»å¡çŠ¶æ€.å½“sleep()çŠ¶æ€è¶…æ—¶ã€join()ç­‰å¾…çº¿ç¨‹ç»ˆæ­¢æˆ–è€…è¶…æ—¶ã€æˆ–è€…I/Oå¤„ç†å®Œæ¯•æ—¶,çº¿ç¨‹é‡æ–°è½¬å…¥å°±ç»ªçŠ¶æ€.

sleepç¤ºä¾‹:

```java
package com.dashidan.lesson18;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * çº¿ç¨‹é˜»å¡çŠ¶æ€ sleep()
 */
public class Demo4 {
    public static void main(String[] args) {
        SleepThread thread = new SleepThread();
        thread.start();
    }
}

class SleepThread extends Thread {
    @Override
    public void run() {
        try {
            System.out.println("before sleep.");
            /** ä¼‘çœ 3ç§’*/
            Thread.sleep(3000);
            /** 3ç§’åè¾“å‡º*/
            System.out.println("after sleep.");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

```

è¾“å‡º:

	before sleep.
	after sleep.

5. æ­»äº¡çŠ¶æ€(Dead)

å¦‚æœä¸€ä¸ªçº¿ç¨‹çš„runæ–¹æ³•æ‰§è¡Œç»“æŸæˆ–è€…è°ƒç”¨stopæ–¹æ³•å,è¯¥çº¿ç¨‹å°±ä¼šæ­»äº¡ç»“æŸç”Ÿå‘½å‘¨æœŸ.å¯¹äºå·²ç»æ­»äº¡çš„çº¿ç¨‹,æ— æ³•å†ä½¿ç”¨startæ–¹æ³•ä»¤å…¶è¿›å…¥å°±ç»ª.


â‘¦ çº¿ç¨‹æ­»é”
---
çº¿ç¨‹æ­»é”æ˜¯æŒ‡2ä¸ªçº¿ç¨‹éƒ½åœ¨åŒæ­¥é˜»å¡çŠ¶æ€, ç­‰å¾…å¯¹è±¡çš„é”, åœ¨å¯¹æ–¹çš„çº¿ç¨‹ä¸­æ— æ³•é‡Šæ”¾. è¿™æ ·ä¼šå¯¼è‡´è¿™ä¸¤ä¸ªçº¿ç¨‹å¡æ­», æ— æ³•ç»§ç»­æ‰§è¡Œ. å¼€å‘æ—¶åº”æåŠ›é¿å….

```java
package com.dashidan.lesson18;


/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * çº¿ç¨‹æ­»é”
 */
public class Demo6 {

    public static LockObject lockA = new LockObject("LOCK-A");
    public static LockObject lockB = new LockObject("LOCK-B");

    public static void main(String[] args) {
        /** æ³¨æ„è¿™ä¸¤ä¸ªçº¿ç¨‹ä¼ å…¥çš„å‚æ•°ï¼Œé¡ºåºä¸ä¸€æ ·, lockA, lockB*/
        LockThread thread1 = new LockThread("t1", lockA, lockB);
        thread1.start();
        /** æ³¨æ„è¿™ä¸¤ä¸ªçº¿ç¨‹ä¼ å…¥çš„å‚æ•°ï¼Œé¡ºåºä¸ä¸€æ ·, lockB, lockA*/
        LockThread thread2 = new LockThread("t2", lockB, lockA);
        thread2.start();
    }
}

class LockThread extends Thread {

    LockObject lock0;
    LockObject lock1;

    public LockThread(String name, LockObject lock0, LockObject lock1) {
        super(name);
        this.lock0 = lock0;
        this.lock1 = lock1;
    }

    @Override
    public void run() {
        try {
            synchronized (lock0) {
                System.out.println(getName() + "æŒæœ‰å¯¹è±¡é” " + lock0.getName());
                Thread.sleep(3000);
                System.out.println(getName() + "ç­‰å¾…å¯¹è±¡é” " + lock1.getName() + " ... ");
                synchronized (lock1) {
                    System.out.println(getName() + "æŒæœ‰å¯¹è±¡é” " + lock1.getName());
                    Thread.sleep(3000);
                }
				/** Attentionï¼è¿™ä¸€è¡Œå¹¶æ²¡æœ‰è¾“å‡º*/
                System.out.println(getName() + "æ‰§è¡Œå®Œæ¯•");
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

/**
 * ä¸€ä¸ªç®€å•çš„é”å¯¹è±¡
 */
class LockObject {
    /**
     * å¯¹è±¡åå­—
     */
    private String name;

    public LockObject(String name) {
        this.name = name;
    }

    public String getName() {
        return name;
    }
}

```

è¾“å‡º:

	t1æŒæœ‰å¯¹è±¡é” LOCK-A
	t2æŒæœ‰å¯¹è±¡é” LOCK-B
	t2ç­‰å¾…å¯¹è±¡é” LOCK-A ... 
	t1ç­‰å¾…å¯¹è±¡é” LOCK-B ... 

<div class="bs-callout bs-callout-warning">
<h4>æ‰§è¡Œå®Œæ¯•è¿™ä¸€å¥å¹¶æ²¡æœ‰è¾“å‡º.</h4>
<p>æ˜¯å› ä¸ºä¸¤ä¸ªçº¿ç¨‹è¿›å…¥äº†çº¿ç¨‹æ­»é”çŠ¶æ€, äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”. ç¼–ç è¿‡ç¨‹ä¸­è¦æåŠ›é¿å…åµŒå¥—è°ƒç”¨é”çš„æƒ…å†µå‡ºç°..</p>
</div>

çº¿ç¨‹æ­»é”å¦‚ä½•æ£€æµ‹?
é™äºç¯‡å¹…é—®é¢˜, æ–°å»ºä¸€ç¯‡æ¥è¯´æ˜.[Javaçº¿ç¨‹æ­»é”æ£€æµ‹](http://dashidan.com).

â‘§ synchronizedç”¨åœ¨å¯¹è±¡, æ–¹æ³•, ä»£ç å—çš„åŒºåˆ«
---
synchronizedå…³é”®å­—çš„æœ¬è´¨æ˜¯`é”å¯¹è±¡`. ç”¨åœ¨å¯¹è±¡ç±»å‹ä¸Š, å³ä¸ºé”å®šç›®æ ‡å¯¹è±¡. ç”¨åœ¨æ–¹æ³•å’Œä»£ç å—ä¸­, è¡¨ç¤ºé”å®šå½“å‰å¯¹è±¡.å¯¹è±¡ä¸€æ—¦è¢«é”å®š, æ‰€æœ‰çš„synchonizedå…³é”®å­—ä¿®é¥°çš„åŒºåŸŸéƒ½éœ€è¦ç­‰å¾…é”é‡Šæ”¾åæ‰èƒ½æ‰§è¡Œ.

å‰è¾¹å‡ ä¸ªä¾‹å­éƒ½æ˜¯synchronizedé”å¯¹è±¡çš„æ–¹å¼.ä¸‹é¢æ¥çœ‹çœ‹ç”¨é”æ–¹æ³•å’Œé”ä»£ç å—.

```java
package com.dashidan.lesson18;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * synchronizedé”æ–¹æ³•å’ŒåŒºå—
 */
public class Demo7 {
    public static void main(String[] args) {
        SyncObject syncObject = new SyncObject();
        Demo7Thread t1 = new Demo7Thread("t1", syncObject);
        t1.start();
        Demo7Thread t2 = new Demo7Thread("t2", syncObject);
        t2.start();
    }
}

class SyncObject {

    /**
     * synchronized é”æ–¹æ³•
     */
    public synchronized void testSyncMethod(String name) {
        try {
            System.out.println(name + "è¿è¡ŒtestSyncMethodå¼€å§‹.");
            Thread.sleep(300);
            System.out.println(name + "è¿è¡ŒtestSyncMethodç»“æŸ.");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    /**
     * synchronized é”ä»£ç åŒºå—
     */
    public void testSyncCode(String name) {
        synchronized (this) {
            try {
                System.out.println(name + "è¿è¡ŒtestSyncCodeå¼€å§‹.");
                Thread.sleep(300);
                System.out.println(name + "è¿è¡ŒtestSyncCodeç»“æŸ.");
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class Demo7Thread extends Thread {
    SyncObject syncObject;

    public Demo7Thread(String name, SyncObject syncObject) {
        super(name);
        this.syncObject = syncObject;
    }

    @Override
    public void run() {
        syncObject.testSyncMethod(this.getName());
        syncObject.testSyncCode(this.getName());
    }
}

```
è¾“å‡º:

	t1è¿è¡ŒtestSyncMethodå¼€å§‹.
	t1è¿è¡ŒtestSyncMethodç»“æŸ.
	t2è¿è¡ŒtestSyncMethodå¼€å§‹.
	t2è¿è¡ŒtestSyncMethodç»“æŸ.
	t1è¿è¡ŒtestSyncCodeå¼€å§‹.
	t1è¿è¡ŒtestSyncCodeç»“æŸ.
	t2è¿è¡ŒtestSyncCodeå¼€å§‹.
	t2è¿è¡ŒtestSyncCodeç»“æŸ.

<div class="bs-callout">
<p>è¿è¡Œç»“æœå¯èƒ½ä¸ä¸€æ ·, ä½†å¼€å§‹å’Œç»“æŸæ€»æ˜¯ä¸€ä¸€å¯¹åº”.åœ¨å¼€å§‹å’Œç»“æŸä¹‹é—´æ²¡æœ‰æ‰§è¡Œå…¶ä»–æ–¹æ³•, è¯´æ˜éƒ½æ˜¯é”çš„åŒä¸€ä¸ªå¯¹è±¡.å¯ä»¥å°†ä»»æ„ä¸€ä¸ªsynchronizedå±è”½,å†è·‘ä¸€ä¸‹ç¨‹åº,å°±ä¼šå‘ç°è¾“å‡ºä¸­çš„å¼€å§‹å’Œç»“æŸä¸å†ä¸€ä¸€å¯¹åº”.</p>
</div>

â‘¨ Lockå¯¹è±¡
---

JDK1.5å¼€å§‹æä¾›äº†ä¸€ä¸ªæ›´åŠ é«˜æ•ˆçš„é”çš„æ–¹å¼.concurrentåŒ…ä¸­Lockå¯¹è±¡.æœ€å¤§çš„ä¼˜åŠ¿æ˜¯å¯ä»¥è¯»å†™é”åˆ†ç¦», åŠ å…¥å†™é”å, è¯»é”éœ€è¦ç­‰å†™é”é‡Šæ”¾åå†è¿›è¡Œ. åŠ å…¥è¯»é”å, è¿˜æ˜¯å¯ä»¥è·å–å†™é”, ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨, ä½¿ç”¨å†™é”çš„æ—¶å€™. åŒä¸€ä¸ªå¯¹è±¡å¯ä»¥ä½¿ç”¨å¤šä¸ªLockå¯¹è±¡, é”å®šå¯¹åº”çš„èŒƒå›´, è€Œä¸åƒsynchonizedé”æ•´ä¸ªå¯¹è±¡. 
å®˜æ–¹ä¾‹å­
```java
class CachedData {
    Object data;
    volatile boolean cacheValid;
    final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();

    void processCachedData() {
        rwl.readLock().lock();
        if (!cacheValid) {
            // Must release read lock before acquiring write lock
            rwl.readLock().unlock();
            rwl.writeLock().lock();
            try {
                // Recheck state because another thread might have
                // acquired write lock and changed state before we did.
                if (!cacheValid) {
                    data =...
                    cacheValid = true;
                }
                // Downgrade by acquiring read lock before releasing write lock
                rwl.readLock().lock();
            } finally {
                rwl.writeLock().unlock(); // Unlock write, still hold read
            }
        }
        try {
            use(data);
        } finally {
            rwl.readLock().unlock();
        }
    }
}
```
ä¸€ä¸ªç®€å•çš„è¯»å†™é”ä¾‹å­
```java
package com.dashidan.lesson18;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantReadWriteLock;

/**
 * å¤§å±è›‹æ•™ç¨‹ç½‘-dashidan.com
 * <p>
 * Javaæ•™ç¨‹åŸºç¡€ç¯‡:  18.Javaçº¿ç¨‹
 * Lockå¯¹è±¡
 */
public class Demo8 {

    public static void main(String[] args) {
        LockObjectReadAndWrite lockObj = new LockObjectReadAndWrite();
        /** å†™çº¿ç¨‹*/
        WriteThread writeThread = new WriteThread("w1", lockObj);
        writeThread.start();
        /** è¯»çº¿ç¨‹*/
        ReadThread readThread = new ReadThread("r1", lockObj);
        readThread.start();
    }
}

class LockObjectReadAndWrite {

    private final Map<String, Integer> m = new HashMap<>();
    private final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
    private final Lock readLock = rwl.readLock();
    private final Lock writeLock = rwl.writeLock();

    public Integer get(String key, String threadName) {
        System.out.println("åŠ å…¥è¯»é” " + threadName);
        readLock.lock();
        try {
            System.out.println("è¯»å–ä¼‘æ¯1ç§’");
            Thread.sleep(1000);
            return m.get(key);
        } catch (InterruptedException e) {
            e.printStackTrace();
            return -1;
        } finally {
            readLock.unlock();
            System.out.println("é‡Šæ”¾è¯»é” " + threadName);
        }
    }

    public Integer put(String key, Integer value, String threadName) {
        System.out.println("------WriteThread åŠ å…¥å†™é”------ : " + threadName);
        writeLock.lock();
        try {
            System.out.println("å†™å…¥ä¼‘æ¯6ç§’.....");
            Thread.sleep(6000);
            return m.put(key, value);
        } catch (InterruptedException e) {
            e.printStackTrace();
            return -1;
        } finally {
            writeLock.unlock();
            System.out.println("------WriteThread é‡Šæ”¾å†™é”------: " + threadName);
        }
    }
}

class WriteThread extends Thread {

    LockObjectReadAndWrite lockObj;

    public WriteThread(String name, LockObjectReadAndWrite lockObj) {
        super(name);
        this.lockObj = lockObj;
    }

    @Override
    public void run() {
        while (true) {
            /** æŒç»­å†™å…¥*/
            lockObj.put("a", 1, this.getName());
            /** å†™å…¥çº¿ç¨‹ä¼‘æ¯3ç§’*/
            try {
                Thread.sleep(3000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

        }
    }
}

class ReadThread extends Thread {

    LockObjectReadAndWrite lockObj;

    public ReadThread(String name, LockObjectReadAndWrite lockObj) {
        super(name);
        this.lockObj = lockObj;
    }

    @Override
    public void run() {
        while (true) {
            /** æŒç»­è¯»å–*/
            lockObj.get("a", this.getName());
        }
    }
}

```

è¾“å‡º:

	åŠ å…¥è¯»é” r1
	è¯»å–ä¼‘æ¯1ç§’
	------WriteThread åŠ å…¥å†™é”------ : w1
	é‡Šæ”¾è¯»é” r1
	å†™å…¥ä¼‘æ¯6ç§’.....
	åŠ å…¥è¯»é” r1
	------WriteThread é‡Šæ”¾å†™é”------: w1
	è¯»å–ä¼‘æ¯1ç§’
	é‡Šæ”¾è¯»é” r1
	åŠ å…¥è¯»é” r1
	è¯»å–ä¼‘æ¯1ç§’
	é‡Šæ”¾è¯»é” r1
	åŠ å…¥è¯»é” r1
	è¯»å–ä¼‘æ¯1ç§’
	------WriteThread åŠ å…¥å†™é”------ : w1
	å†™å…¥ä¼‘æ¯6ç§’.....
	é‡Šæ”¾è¯»é” r1
	åŠ å…¥è¯»é” r1

<div class="bs-callout">
<p>è¾“å‡ºç»“æœå¯èƒ½ä¸ä¸€æ ·. ä½†æ¯æ¬¡åŠ ä¸Šå†™é”ä¹‹å, è¯»å–çš„æ“ä½œä¾¿åœæ­¢. é‡Šæ”¾å†™é”å, è¯»å–ç»§ç»­.</p>
</div>

â‘© çº¿ç¨‹å¸¸è§é—®é¢˜ 
---

* çº¿ç¨‹çš„åå­—

é»˜è®¤çº¿ç¨‹å:`Thread-`åŠ `ä¸‹ä¸€çº¿ç¨‹æ•°`:

```java
public Thread() {
	init(null, null, "Thread-" + nextThreadNum(), 0);
}
```

è‡ªå®šä¹‰çº¿ç¨‹å:

åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥çº¿ç¨‹å.

```java
public Thread(Runnable target, String name) {
	init(null, target, name, 0);
}
```

* è·å–å½“å‰çº¿ç¨‹å¯¹è±¡çš„æ–¹æ³•
```java
Thread.currentThread().
```

* å½“çº¿ç¨‹ç›®æ ‡`run()`æ–¹æ³•ç»“æŸæ—¶, è¯¥çº¿ç¨‹ç»“æŸ.
* ä¸€ä¸ªçº¿ç¨‹åªèƒ½å¯åŠ¨ä¸€æ¬¡, ä¸€æ—¦çº¿ç¨‹å¯åŠ¨, ä¸èƒ½å†é‡æ–°å¯åŠ¨.
* çº¿ç¨‹çš„è°ƒåº¦ç”±Javaè™šæ‹Ÿæœº(JVM)æ§åˆ¶.

åœ¨å•æ ¸CPUçš„ç”µè„‘ä¸Š,å®é™…ä¸Šä¸€æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹,CPUåˆ†æ—¶å¤„ç†,çœ‹ä¸Šå»å‘åŒæ­¥è¿è¡Œä¸€æ ·.å¤šæ ¸CPUçš„ç”µè„‘åŒæ—¶å¯ä»¥è¿è¡Œå¤šä¸ªçº¿ç¨‹.Javaè™šæ‹Ÿæœºå†³å®šå®é™…è¿è¡Œå“ªä¸ªçº¿ç¨‹.æœ‰å¤šä¸ªå¯è¿è¡Œçº¿ç¨‹æ—¶,å…¶ä¸­çš„æŸä¸€ä¸ªä¼šè¢«Javaè™šæ‹Ÿæœºé€‰ä¸ºå½“å‰çº¿ç¨‹.é»˜è®¤æƒ…å†µä¸‹ä¸èƒ½ä¿è¯çº¿ç¨‹è¿è¡Œçš„å…ˆåé¡ºåº.é‡å­ç†è®ºçš„ä¸Šå¸æ·éª°å­.

![çˆ±å› æ–¯å¦](http://localhost/img/common/aiyinsitan.jpg)

â‘ª ç›¸å…³æ–‡ç« 
---

ğŸ“– [Javaç¤ºä¾‹ä»£ç ä½¿ç”¨æ–¹æ³•](http://localhost/article/java/addenda/Javaç¤ºä¾‹ä»£ç ä½¿ç”¨æ–¹æ³•.html)   