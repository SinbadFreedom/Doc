1.æ‹¯æ•‘å•èº«ç‹—
===

<div class="jumbotron">
	<p>ä¸€å¹´ä¸€åº¦çš„å…‰æ£èŠ‚åˆåˆ°äº†!å•èº«ç‹—è¡¨ç¤ºå—åˆ°ä¸€ä¸‡ç‚¹ä¼¤å®³,æ‰€ä»¥è¦ä¸ºå•èº«ç‹—åšç‚¹ä»€ä¹ˆ.æ‹¯æ•‘å•èº«ç‹—!æ©çˆ±ç‹—ç¾¤ä¸­æ•‘å‡ºå•èº«ç‹—!</p>  
</div>
	
	
â‘  æ¸¸æˆè®¾è®¡
---

html5å°æ¸¸æˆ, ä»å±å¹•ä¸Šéšæœºå‡ºç°å•èº«ç‹—,æˆ–è€…æƒ…ä¾£ç‹—.

ç„¶åä»ä¼—å¤šçš„ç‹—ä¸­, é€‰æ‹©å•èº«ç‹—, å°†å•èº«ç‹—è§£æ•‘å‡ºæ¥.

é€‰ä¸­ä¸€ä¸ªåŠ ä¸€åˆ†, ç‚¹é”™æ¸¸æˆç»“æŸ.

å°±è¿™æ ·, å¾ˆç®€å•å§.

ğŸ® [æ‹¯æ•‘å•èº«ç‹—å°æ¸¸æˆ](http://localhost/game/save_the_single_dog/index.html)

â‘¡ å‡†å¤‡å·¥ä½œ
---

* èµ„æºå›¾ç‰‡: 4åªå•èº«ç‹—, 4åŒæƒ…ä¾£ç‹—, æ¸¸æˆé—ªå±é¡µé¢

æ¸¸æˆé—ªå±é¡µé¢:

![1](http://localhost/img/game/save_the_single_dog/splash.jpg)

å…«éªå›¾:

![2](http://localhost/img/game/save_the_single_dog/dog.jpg)

* å‹¤åŠ³çš„åŒæ‰‹, è¯´çš„å°±æ˜¯ä½ å•¦.
* çµæ´»çš„å¤§è„‘, è¿˜æ˜¯ä½ .
* äº†è§£JavaScript, htmlçš„åŸºç¡€è¯­æ³•å³å¯.

â‘¢ HTMLç¼–ç 
---

html5æ–°å¢åŠ äº†`canvas`æ ‡ç­¾, è¿™ä¸ªæ˜¯æˆ‘ä»¬åšè¿™ä¸ªæ¸¸æˆçš„åŸºç¡€.

ç½‘é¡µä¸­åµŒå…¥`canvas`æ ‡ç­¾:

```html
<div class="text-center">
	<canvas id="myCanvas" width="360" height="640">Your browser does not support the canvas element.</canvas>
</div>
```

æˆ‘ä»¬å°†`JavaScript`è„šæœ¬æ–°å»ºä¸€ä¸ª, åœ¨htmlé¡µé¢ä¸­å¯¼å…¥

```html
<script src="Game.js"></script>
```

â‘£ JavaScriptç¼–ç 
---

é€»è¾‘å†™åœ¨`Game.js`æ–‡ä»¶ä¸­.

###1.è·å–ç»˜åˆ¶å¯¹è±¡

```javascript
const canvas = document.getElementById("myCanvas");
const ctx = canvas.getContext("2d");
```

###2.å®šä¹‰æ¸¸æˆå˜é‡

```javascript
/** æ¸¸æˆåŒºåŸŸ*/
const WIDTH = 360;
const HEIGHT = 640;
/** å¸§ç‡*/
const FRAME_INTERVAL = 33;
/** å•èº«ç‹—é€Ÿåº¦*/
const DOG_SPEED_SINGLE = 4;
/** å•èº«ç‹—è·¯, å“‡å¡å•èº«ç‹—æœ‰3æ¡è·¯èµ°*/
const DOG_ROAD = 3;
/** ç‹—æ•°é‡*/
const DOG_NUM = 8;
/** å€’è®¡æ—¶*/
let countDown = 3;
/** æ‹¯æ•‘æ•°é‡*/
let saveCount = 0;
/** æ€»æ•°é‡*/
let totalCount = 0;

const SPRITE_WIDTH = 100;
```

###3.åˆå§‹åŒ–å›¾åƒ

```javascript
let splashImg = new Image();
let logoImg = new Image();
let dogImg = new Image();

logoImg.src = "dashidan_log.jpg";
let loadFinish = false;
logoImg.onload = function () {
    dogImg.src = "dog.jpg";
    dogImg.onload = function () {
        loadFinish = true;
    };
};

```

###4.åˆå§‹åŒ–å›¾åƒ

è®¾å®šæ¸¸æˆçŠ¶æ€, æœ¬æ¸¸æˆçš„æ¸¸æˆçŠ¶æ€åˆ†ä¸º: é—ªå±çŠ¶æ€, èƒŒæ™¯å™è¿°çŠ¶æ€, å€’è®¡æ—¶, æ¸¸æˆä¸­, æ¸¸æˆç»“æŸ. è¿™å‡ ä¸ªçŠ¶æ€.

```js
/** é—ªå±çŠ¶æ€*/
const GAME_STATE_SPLASH = 1;
/** èƒŒæ™¯å™è¿°çŠ¶æ€*/
const GAME_STATE_INFO = 2;
/** å€’è®¡æ—¶*/
const GAME_STATE_COUNT_DOWN = 3;
/** æ¸¸æˆä¸­*/
const GAME_STATE_GAMING = 4;
/** æ¸¸æˆç»“æŸ*/
const GAME_STATE_GAME_OVER = 5;
```


###4.è®¾å®šæ¸¸æˆçŠ¶æ€æœº

æ¸¸æˆçŠ¶æ€æœºæ¥è¿›è¡Œæ¸¸æˆçŠ¶æ€ç®¡ç†å’Œåˆ‡æ¢çš„åŠŸèƒ½.

```js
function render() {
    if (!loadFinish) {
        return;
    }

    switch (gameState) {
        case GAME_STATE_SPLASH:
            renderSlash();
            break;
        case GAME_STATE_INFO:
            renderText();
            break;
        case GAME_STATE_GAMING:
            renderGame();
            break;
        case GAME_STATE_COUNT_DOWN:
            renderCountDown();
            break;
        case GAME_STATE_GAME_OVER:
            renderGameOver();
            break;
    }
}

```

###5.ç»˜åˆ¶é—ªå±çŠ¶æ€

```js
function renderSlash() {
    console.log("-----renderSlash--------");
    if (!isDrawSplash) {
        splashImg = new Image();
        splashImg.src = "http://localhost/img/game/save_the_single_dog/splash.jpg";
        splashImg.onload = function () {
            ctx.drawImage(splashImg, 0, 0);
        };
        isDrawSplash = true;
    }

    if (gameStep > 100) {
        ctx.clearRect(0, 0, WIDTH, HEIGHT);

        if (ctx.globalAlpha > 0) {
            ctx.globalAlpha -= 0.01;
        }
        ctx.drawImage(splashImg, 0, 0);
        if (gameStep > 200) {
            updateGameState(GAME_STATE_INFO)
        }
    }
}
```


###5.ç»˜åˆ¶èƒŒæ™¯å™è¿°çŠ¶æ€


```js
function renderText() {
    console.log("-----renderText--------");

    let textArr = [];
    textArr.push("ä¸€å¹´ä¸€åº¦çš„å…‰æ£èŠ‚åˆåˆ°äº†!");
    textArr.push("å•èº«ç‹—è¡¨ç¤ºå—åˆ°ä¸€ä¸‡ç‚¹ä¼¤å®³");
    textArr.push("æ‰€ä»¥è¦ä¸ºå•èº«ç‹—åšç‚¹ä»€ä¹ˆ");
    textArr.push("æ‹¯æ•‘å•èº«ç‹—!");
    textArr.push("æ©çˆ±ç‹—ç¾¤ä¸­æ•‘å‡ºå•èº«ç‹—!");

    if (gameStep % 5 == 1) {
        if (textArr[textArrayIndex]) {
            if (textIndex >= textArr[textArrayIndex].length) {
                textArrayIndex++;
                textIndex = 0;
            } else {
                ctx.fillStyle = "#000000";
                ctx.font = "20px å¾®è½¯é›…é»‘";
                ctx.fillText(textArr[textArrayIndex].substr(textIndex, 1), 30 * textIndex,
                             100 + textArrayIndex * 30 + 100);
                textIndex++;
            }
        } else {
            updateGameState(GAME_STATE_COUNT_DOWN)
        }
    }
}
```

###6.ç»˜åˆ¶å€’è®¡æ—¶


```js
function renderCountDown() {
    console.log("-----renderCountDown--------");
    if (gameStep % 30 == 1) {
        if (countDown > 0) {
            ctx.fillStyle = "#666666";
            ctx.fillRect(0, 0, WIDTH, HEIGHT);
            ctx.fillStyle = "#000000";
            ctx.font = "100px å¾®è½¯é›…é»‘";
            ctx.fillText(countDown + "", 160, 300);
            countDown--;
        } else {
            updateGameState(GAME_STATE_GAMING)
        }
    }
}
```


###7.å®šä¹‰å•èº«ç‹—çš„ä¿¡æ¯


```js
class DogInfo {

    constructor(dogIndex, roadIndex, posX, posY) {
        this._dogIndex = dogIndex;
        this._roadIndex = roadIndex;
        this._posX = posX;
        this._posY = posY;
    }

    get dogIndex() {
        return this._dogIndex;
    }

    get roadIndex() {
        return this._roadIndex;
    }

    set posX(value) {
        this._posX = value;
    }

    get posX() {
        return this._posX;
    }

    get posY() {
        return this._posY;
    }

    set posY(value) {
        this._posY = value;
    }
}

```

###8.ç»˜åˆ¶æ¸¸æˆè¿‡ç¨‹

```js
function renderGame() {
    if (gameStep % FRAME_INTERVAL * 3 == 0) {
        let dogIndex = parseInt(Math.random() * DOG_NUM);
        let roadIndex = parseInt(Math.random() * DOG_ROAD);
        dogOnTheRoad.push(new DogInfo(dogIndex, roadIndex, 0, 0));
        totalCount++;
    }

    ctx.fillStyle = "#666666";
    ctx.fillRect(0, 0, WIDTH, HEIGHT);

    for (let i = 0; i < dogOnTheRoad.length; i++) {
        dogOnTheRoad[i].posX = 20 + dogOnTheRoad[i].roadIndex * 110;
        let addY = (DOG_SPEED_SINGLE + parseInt(totalCount / 10));
        dogOnTheRoad[i].posY += addY;
        console.log("addY : " + addY + " dogOnTheRoad[i].posY " + dogOnTheRoad[i].posY);
        ctx.drawImage(dogImg, dogOnTheRoad[i].dogIndex * SPRITE_WIDTH, 0, SPRITE_WIDTH, SPRITE_WIDTH,
                      dogOnTheRoad[i].posX, dogOnTheRoad[i].posY, SPRITE_WIDTH, SPRITE_WIDTH);
    }

    ctx.fillStyle = "#008ace";
    ctx.fillRect(0, 0, WIDTH, 30);
    ctx.fillStyle = "#ffffff";
    ctx.font = "20px å¾®è½¯é›…é»‘";
    ctx.fillText("æ‹¯æ•‘å•èº«ç‹—æ•°é‡: ", 90, 20);
    ctx.fillStyle = "#00ff00";
    ctx.font = "20px å¾®è½¯é›…é»‘";
    ctx.fillText(saveCount + "", 240, 20);
}
```

###9.ç»˜åˆ¶æ¸¸æˆç»“æŸ

```
function renderGameOver() {
    ctx.fillStyle = "#000000";
    ctx.fillRect(0, 0, WIDTH, HEIGHT);
    ctx.fillStyle = "#ffffff";
    ctx.font = "40px å¾®è½¯é›…é»‘";
    ctx.fillText("å…±æ‹¯æ•‘å•èº«ç‹—", 60, 260);
    ctx.fillStyle = "#00ff00";
    ctx.font = "40px å¾®è½¯é›…é»‘";
    ctx.fillText(saveCount + "", 160, 300);
    ctx.fillStyle = "#ffffff";
    ctx.font = "40px å¾®è½¯é›…é»‘";
    ctx.fillText("åª!", 160, 340);
}
```


###10.å¾ªç¯æ¸²æŸ“

`JavaScript`ä¸­é€šè¿‡`setInterval`æ–¹æ³•æ¥é—´éš”ä¸€æ®µæ—¶é—´å¾ªç¯æ‰§è¡Œ.

```js
window.setInterval(render, FRAME_INTERVAL);
```

###11.å¤„ç†é¼ æ ‡ç‚¹å‡»äº‹ä»¶

```js
canvas.addEventListener('click', function (event) {
    if (gameState != GAME_STATE_GAMING) {
        return;
    }

    console.log("ev " + event);
    let x, y;
    if (event.layerX || event.layerX == 0) {
        x = event.layerX;
        y = event.layerY;
    } else if (event.offsetX || event.offsetX == 0) { // Opera
        x = event.offsetX;
        y = event.offsetY;
    }
    console.log("ev " + event + " x " + x + " y " + y);

    for (let i = 0; i < dogOnTheRoad.length; i++) {
        if (dogOnTheRoad[i].dogIndex < 4) {
            if (x >= dogOnTheRoad[i].posX
                && x <= dogOnTheRoad[i].posX + 100
                && y >= dogOnTheRoad[i].posY
                && y <= dogOnTheRoad[i].posY + 100) {
                saveCount++;
                /** ç§»é™¤å•èº«ç‹—*/
                dogOnTheRoad.splice(i, 1);
                return;
            }
        } else {
            /** ç‚¹ä¸­æ©çˆ±ç‹—*/
        }
    }

    updateGameState(GAME_STATE_GAME_OVER)
});
```


â‘¤ çŸ¥è¯†ç‚¹æ•´ç†
---

è¿™ä¸ªå°æ¸¸æˆä¸»è¦æ¶‰åŠåˆ°äº†ä»¥ä¸‹çŸ¥è¯†ç‚¹.

* `h5`çš„`canvas`æ ‡ç­¾
* `html`åŠ è½½å¤–éƒ¨`JavaScript`æ–‡ä»¶
* è·å–`canvas`çš„å¹³é¢ç»˜åˆ¶å¯¹è±¡`getContext(2d)`
* `JavaScript`ä¸­å¸¸é‡å®šä¹‰`const`
* `JavaScript`ä¸­å±€éƒ¨å˜é‡å®šä¹‰`let`
* `JavaScript`å›è°ƒå‡½æ•°çš„ä½¿ç”¨
* `JavaScript`çš„`Image`å¯¹è±¡
* `JavaScript`çš„`switch`æ¡ä»¶æ§åˆ¶è¯­å¥
* `canvas`ç»˜åˆ¶å›¾åƒ
* `canvas`å›¾åƒæ¸éš
* `canvas`ç»˜åˆ¶å­—ä½“
* `JavaScript`çš„`class`å¯¹è±¡ä½¿ç”¨
* `JavaScript`çš„é—´éš”ä¸€å®šæ—¶é—´, å¤šæ¬¡æ‰§è¡Œ
* `canvas`åŠ¨æ€ç»˜åˆ¶å›¾åƒ
* `canvas`é¼ æ ‡ç‚¹å‡»äº‹ä»¶å¤„ç†

å¸Œæœ›é€šè¿‡è¿™ä¸ªå°æ¸¸æˆ, èƒ½æ„Ÿåˆ°ä¸€ç‚¹ç¼–ç¨‹å¸¦æ¥çš„å¿«ä¹, å¹¶èƒ½æŒæ¡å¯¹åº”çš„çŸ¥è¯†ç‚¹.


â‘¥ ç›¸å…³æ–‡ç« 
---

ğŸ“– [å¤§å±è›‹æ•™ç¨‹ç½‘](http://localhost/game/save_the_single_dog/index.html)

ğŸ® [æ‹¯æ•‘å•èº«ç‹—å°æ¸¸æˆ](http://localhost/game/save_the_single_dog/index.html)
