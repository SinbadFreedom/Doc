16.MongoDbéå†ç»“æœcursor
===

`db.collection.find()`æ–¹æ³•è¿”å›ä¸€ä¸ªç»“æœæŒ‡é’ˆ. è®¿é—®ç»“æœæ•°æ®éœ€è¦å¯¹æŒ‡é’ˆè¿›è¡Œè¿­ä»£æŸ¥è¯¢. åœ¨mongoå‘½ä»¤ä¸­, æŸ¥è¯¢ç»“æœ`cursor`é»˜è®¤è¿”å›20æ¡æ•°æ®, é»˜è®¤å¯¹`cursor`è¿›è¡Œè¿­ä»£20æ¬¡. å¯ä»¥é€šè¿‡ä¿®æ”¹`DBQuery.shellBatchSize`å€¼æ¥æ”¹å˜ç»“æœæ˜¾ç¤ºæ•°é‡.

â‘  æ‰‹åŠ¨éå†æŸ¥è¯¢ç»“æœcursor
---

å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥, æ‰“å°å‰20æ¡æ•°æ®

```
var myCursor = db.users.find( { type: 2 } );

myCursor
```

ä½ å¯ä»¥é€šè¿‡`next()`æ–¹æ³•éå†è®¿é—®æ–‡æ¡£æ•°æ®

```
var myCursor = db.users.find( { type: 2 } );

while (myCursor.hasNext()) {
   print(tojson(myCursor.next()));
}
```

å¦å¤–,ä¹Ÿå¯ä»¥é€šè¿‡`printjson()`æ–¹æ³•æ¥æ›¿ä»£`print(tojson())`æ–¹æ³•.

```
var myCursor = db.users.find( { type: 2 } );

while (myCursor.hasNext()) {
   printjson(myCursor.next());
}
```

å¯ä»¥ä½¿ç”¨`cursor`æä¾›çš„`forEach()`æ–¹æ³•æ¥éå†ç»“æœé›†.

```
var myCursor =  db.users.find( { type: 2 } );

myCursor.forEach(printjson);
```

cursorç›¸å…³çš„å…¶ä»–æ–¹æ³•:
[JavaScript cursor methods](https://docs.mongodb.com/manual/reference/method/#js-query-cursor-methods)


â‘¡ éå†ç´¢å¼•
---

åœ¨mongoå‘½ä»¤ä¸­å¯ä»¥é€šè¿‡`toArray()`æ–¹æ³•éå†ç»“æœé›†, å¹¶å°†ç»“æœé›†æ”¾åœ¨ä¸€ä¸ªæ•°ç»„ä¸­è¿”å›.

```
var myCursor = db.inventory.find( { type: 2 } );
var documentArray = myCursor.toArray();
var myDocument = documentArray[3];
```

`toArray()`æ–¹æ³•å°†å…¨éƒ¨ç»“æœæ•°æ®æ”¾åœ¨å†…å­˜ä¸­.`toArray()`éå†å®Œå…¨éƒ¨æŒ‡é’ˆæ•°æ®.

æœ‰éƒ¨åˆ†Mongodbæ•°æ®åº“é©±åŠ¨æä¾›æ ¹æ®cursorç´¢å¼•ä½ç½®è·å–æ–‡æ¡£æ•°æ®çš„æ–¹æ³•.(ä¾‹å¦‚:`cursor[index]`). è¿™æ˜¯å…ˆè°ƒç”¨`toArray()`æ–¹æ³•å†ç”¨ç´¢å¼•è·å–æ•°ç»„ä¸­å…ƒç´ çš„ç®€å†™.

```
var myCursor = db.users.find( { type: 2 } );
var myDocument = myCursor[1];
```

`myCursor[1]`ç­‰åŒäºä»¥ä¸‹:

```
myCursor.toArray() [1];
```


â‘¢ Cursorè¡Œä¸º
---

###1.å…³é—­ä¸æ´»åŠ¨çš„Cursor

é»˜è®¤æƒ…å†µä¸‹, ä¸€ä¸ªCursoråœæ­¢ä½¿ç”¨è¶…è¿‡10åˆ†é’Ÿæˆ–è€…å®¢æˆ·ç«¯ä½¿ç”¨å®Œæ¯•, æœåŠ¡å™¨ä¼šè‡ªåŠ¨å…³é—­è¿™ä¸ªCursor. åœ¨mongoå‘½ä»¤ä¸­, å¯ä»¥é€šè¿‡`cursor.noCursorTimeout()`æ–¹æ³•, æ”¹å˜è¿™ä¸ªè¡Œä¸º.

```
var myCursor = db.users.find().noCursorTimeout();
```

è®¾å®š`noCursorTimeout`è¿™ä¸ªé€‰é¡¹å,ä½ å¿…é¡»é€šè¿‡`cursor.close()`æ–¹æ³•æ‰‹åŠ¨å…³é—­, æˆ–è€…ç”¨å°½cursorçš„ç»“æœé›†.

###2.Cursoråˆ†ç¦»

ä¸€ä¸ªCursorè¿”å›çš„æ•°æ®æ–‡æ¡£, å…¶ä»–çš„æ“ä½œå¯èƒ½äº¤é”™æ‰§è¡Œ. [MMMPv1](https://docs.mongodb.com/manual/core/mmapv1/)å­˜å‚¨å¼•æ“ä¸­, äº¤é”™æ‰§è¡Œå†™æ“ä½œ, å¯èƒ½å¯¼è‡´è¿”å›çš„cursorä¸­åŒ…å«å¤šæ¬¡åŒæ ·çš„ä¸€æ¡æ•°æ®. å¤„ç†è¿™ç§æƒ…å†µ, å‚è€ƒ[snapshot mode](https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/#faq-developers-isolate-cursors).

###3.Cursoræ‰¹å¤„ç†

MongoDBæœåŠ¡å™¨å°†ç»“æœæ‰“åŒ…è¿”å›. æ•°æ®åŒ…çš„å¤§å°ä¸èƒ½è¶…è¿‡é»˜è®¤BOSNæ–‡æ¡£å¤§å°(16M)[maximum BSON document size](https://docs.mongodb.com/manual/reference/limits/#limit-bson-document-size). å¯ä»¥é€šè¿‡`batchSize()`å’Œ`limit()`æ¥ä¿®æ”¹è¿”å›ç»“æœé›†.

3.4ç‰ˆæœ¬æ–°ç‰¹æ€§
`find()`, `aggregate()`, `listIndexes`, å’Œ`listCollections`æ¯æ‰¹è¿”å›æœ€å¤§16Mçš„æ•°æ®.`batchSize()`å¯ä»¥è®¾ç½®ä¸€ä¸ªæ›´å°çš„é™åˆ¶, è€Œä¸æ˜¯æœ€å¤§çš„é™åˆ¶.

`find()`å’Œ`aggregate()`é»˜è®¤åˆå§‹é›†åˆæ–‡æ¡£æ•°é‡æ˜¯`101`.

3.2ç‰ˆæœ¬ä»¥åçš„`getMore`æ“ä½œ,æ²¡æœ‰é»˜è®¤é›†åˆæ–‡æ¡£æ•°é‡é™åˆ¶, åªæ˜¯æœ‰16Mæœ€å¤§å­—èŠ‚æ•°é™åˆ¶.

æ³¨:
æŸ¥è¯¢`æ²¡æœ‰ç´¢å¼•`çš„æ•°æ®, é€šè¿‡`sort`æ’åºæ—¶, è¿”å›ç»“æœå‰, æœåŠ¡å™¨å¿…é¡»å°†å…¨éƒ¨æ•°æ®åŠ è½½è¿›å†…å­˜ä¸­æ¥å®ç°æ’åº.

éå†ç»“æœé›†åˆ°è¾¾è¿”å›æ•°æ®çš„æœ«å°¾æ—¶, å¦‚æœæœ‰æ›´å¤šçš„æ•°æ®, `cursor.next()`æ–¹æ³•ä¼šæ‰§è¡Œ`getMore operation`æ“ä½œæ¥å¾—åˆ°ä¸‹ä¸€æ‰¹æ•°æ®. å¯ä»¥é€šè¿‡`objsLeftInBatch()`æ–¹æ³•æ¥æŸ¥çœ‹åœ¨å½“å‰æ•°æ®è¿˜æœ‰å¤šå°‘æ•°æ®æ²¡æœ‰éå†.

```
var myCursor = db.inventory.find();

var myFirstDocument = myCursor.hasNext() ? myCursor.next() : null;

myCursor.objsLeftInBatch();
```

â‘£ Cursorä¿¡æ¯
---

` db.serverStatus()`æ–¹æ³•è¿”å›ä¸€ä¸ªæ–‡æ¡£ï¼Œå…¶ä¸­åŒ…æ‹¬äº†`metrics`å­—æ®µ.[metrics](https://docs.mongodb.com/manual/reference/command/serverStatus/#serverstatus.metrics)å­—æ®µä¸­æœ‰ä¸ªé¢[metrics.cursor](https://docs.mongodb.com/manual/reference/command/serverStatus/#serverstatus.metrics.cursor)å­—æ®µä¸­çš„ä¿¡æ¯:


* æœ€åä¸€æ¬¡æœåŠ¡å™¨é‡å¯ä»¥æ¥è¶…æ—¶cursoræ•°é‡
* ç”±äºè®¾ç½®`DBQuery.Option.noTimeout`æ¥é˜²æ­¢è¶…æ—¶,æ‰“å¼€çš„cursoræ•°é‡.
* `pinned` open cursor æ•°é‡.
* æ‰“å¼€çš„cursorå…¨éƒ¨æ•°é‡.

ä½¿ç”¨ç¤ºä¾‹:

```
db.serverStatus().metrics.cursor
```

æ˜¾ç¤ºç»“æœ:

```
{
   "timedOut" : <number>
   "open" : {
      "noTimeout" : <number>,
      "pinned" : <number>,
      "total" : <number>
   }
}
```

â‘¤ å‚è€ƒæ–‡ç« 
---
 
ğŸ“– [https://docs.mongodb.com/manual/tutorial/iterate-a-cursor/](https://docs.mongodb.com/manual/tutorial/iterate-a-cursor/)


â‘¥ ç›¸å…³æ–‡ç« 
---
 
ğŸ“– [MongoDBä¸­æ–‡æ–‡æ¡£](http://localhost/article/mongodb/index.html)

